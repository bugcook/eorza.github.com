---
layout: post
title: 虚拟内核文件系统
date: 2012-10-15 13:01:27 +0800
categories:
- note
tags:
- linux
---

虚拟内核文件系统（Virtual Kernel File Systems），是指那些是由内核产生但并不存在于硬盘上（存在于内存中）的文件系统，他们被用来与内核进行通信。

ext2，ext3文件系统，都是真真正正、实实在在的存储在具体的外部存储设备上的，它们可能是在本机的硬盘、闪存、光盘中，可能保存在不只一个磁盘分区中，也可能保存在网络中其它主机的存储设备中的。

虚拟文件系统，虽然它们出现在根文件系统中，但它里面的内容却无法在任何外部存储设备中找到，因为它们都在内存中。

## proc文件系统

proc是一个重要虚拟文件系统，通过它里面的一些文件，可以获取系统状态信息并修改某些系统的配置信息。proc文件系统本身不占用磁盘空间，它仅存在于内存之中，为操作系统本身和应用程序之间的通信提供了一个安全的接口。当我们在内核中添加了新功能或设备驱动时，经常需要得到一些系统状态的信息，一般这样的功能可能需要经过一些象ioctl()这样的系统调用来完成。系统调用接口对于一些功能性的信息可能是适合的，因为应用程序必须将这些信息读出后再做一定的处理。但对于一些实时性的系统信息，例如内存的使用状况，或者是驱动设备的统计资料等，我们更需要一个比较简单易用的接口来取得它们。proc文件系统就是这样的一个接口，我们可以简单的用cat、strings程序来查看这些信息。例如，执行下面的命令：

	cat /proc/filesystems //操作系统支持的文件系统类型
	cat /proc/meminfo //内存的实时信息，内存大小等
	cat /proc/partitions //存储器分区信息
	cat /proc/cpuinfo //查看cpu信息

同样，free、df、top、ps等程序的功能实现，强烈依赖于proc文件系统，为了使用那些程序，一定要使内核支持proc文件系统，并将其挂接到根文件系统的/proc目录下。

## devfs文件系统

linux下有专门的文件系统用来对设备进行管理，devfs和sysfs就是其中两种。

在2.6内核以前一直使用的是devfs，devfs挂载于/dev目录下，提供了一种类似于文件的方法来管理位于/dev目录下的所有设备，我们知道/dev目录下的每一个文件都对应的是一个设备，至于当前该设备存在与否先且不论，而且这些特殊文件是位于根文件系统上的，在制作文件系统的时候我们就已经建立了这些设备文件，因此通过操作这些特殊文件，可以实现与内核进行交互。但是devfs文件系统有一些缺点，例如：

不确定的设备映射，有时一个设备映射的设备文件可能不同，例如我的U盘可能对应sda，有可能对应sdb；

没有足够的主/辅设备号，当设备过多的时候，显然这会成为一个问题；

/dev目录下文件太多，而且不能表示当前系统上的实际设备；

命名不够灵活，不能任意指定等等。

## sysfs文件系统

正因为上述这些问题的存在，在linux2.6内核以后，引入了一个新的文件系统sysfs，（其实

sysfs是从proc和devfs中划分出来的。）它挂载于/sys目录下，跟devfs一样，它也是一个虚拟文件系统，不占有任何磁盘空间，也是用来对系统的设备进行管理的，它把实际连接到系统上的设备和总线组织成一个分级的文件，用户空间的程序同样可以利用这些信息以实现和内核的交互，该文件系统是当前系统上实际设备树的一个直观反应，它是通过kobject子系统来建立这个信息的，当一个kobject被创建的时候，对应的文件和目录也就被创建了，位于/sys下的相关目录下。既然每个设备在sysfs中都有唯一对应的目录，那么也就可以被用户空间读写了。用户空间的工具udev 就是利用了sysfs提供的信息来实现所有devfs的功能的，但不同的是udev运行在用户空间中，而devfs却运行在内核空间，而且udev不存在 devfs那些先天的缺陷。很显然，sysfs将是未来发展的方向。

## tmpfs文件系统

tmpfs 是Linux特有的文件系统，唯一的标准挂接点是/dev/shm。当然，用户可以将其挂接在其他地。tmpfs有些像虚拟磁盘（ramdisk），但不是一回事。说其像虚拟磁盘，是因为它可以使用你的RAM，但它也可以使用你的交换分区。传统的虚拟磁盘是一个块设备，而且需要一个mkfs之类的命令格式化它才能使用。tmpfs是一个独立的文件系统，不是块设备，只要挂接，立即就可以使用。tmpfs的大下是不确定的，它最初只有很小的空间，但随着文件的复制和创建，它的大小就会不断变化，换句话说，它会根据你的实际需要而改变大小；tmpfs的速度非常惊人，毕竟它

是驻留在RAM中的，即使用了交换分区，性能仍然非常卓越；由于tmpfs是驻留在RAM的，因此它的内容是不持久的，断电后，tmpfs的内容就消失了，这也是被称作tmpfs的根本原因。

tmpfs 是ramfs的衍生物，用来限制缓存大小、向swap空间写入数据。它是用来保存VM所有文件的文件系统。

tmpfs中缓存的内容全部是临时的。一旦卸载，所有的内容都会遗失。它把所有的缓存置于内核，它的规模随着文件的规模同步变化。但是它规模有大小限制，可以修改。它可以把当前不再需要的页写入到 swap空间。

tmpfs 和 ramfs 本身就是一个文件系统, 用的时候只需要直接挂载就可以. tmpfs可以使用ram, 也可以使用swap。系统默认是内存的一半大小， /dev/shm是挂载点！

## usbdevfs文件系统

顾名思义，usbdevfs就是USB设备文件系统，它是一个动态生成的文件系统，有些类似于proc文件系统。它的标准挂接点是/proc/bus/usb，当然，也可以挂接到其他地方。它主要用于：用户级驱动、即插即用、提供USB设备信息、应用程序轮询USB设备的变化等。

## devpts文件系统

devpts文件系统为伪终端提供了一个标准接口，它的标准挂接点是/dev/pts。只要pty的主复合设备/dev/ptmx被打开，就会在/dev/pts下动态的创建一个新的pty设备文件。挂接时，UID、GID及其工作模式会指定给devpts文件系统的所有pty文件。这可以保证伪终端的安全性。

如下图：

	[root@rh1 pts]# pwd
	/dev/pts
	[root@rh1 pts]# ls -l
	总计 0
	crw--w---- 1 root tty 136, 0 04-30 16:20 0
	crw--w---- 1 root tty 136, 1 04-30 21:52 1
	crw--w---- 1 root tty 136, 2 04-30 21:34 2
	crw--w---- 1 root tty 136, 3 04-30 21:36 3
	crw--w---- 1 root tty 136, 4 04-30 19:43 4
	crw--w---- 1 root tty 136, 5 04-30 21:36 5
	crw--w---- 1 root tty 136, 6 04-30 21:50 6

利用putty登陆linux服务器（或者在linux服务器开启伪终端），再次：

	[root@rh1 pts]# ls -l
	总计 0
	crw--w---- 1 root tty 136, 0 04-30 16:20 0
	crw--w---- 1 root tty 136, 1 04-30 21:54 1
	crw--w---- 1 root tty 136, 2 04-30 21:34 2
	crw--w---- 1 root tty 136, 3 04-30 21:36 3
	crw--w---- 1 root tty 136, 4 04-30 19:43 4
	crw--w---- 1 root tty 136, 5 04-30 21:36 5
	crw--w---- 1 root tty 136, 6 04-30 21:50 6
	crw--w---- 1 root tty 136, 7 04-30 21:54 7

在/dev/pts/目录下，动态创建了一个文件7

